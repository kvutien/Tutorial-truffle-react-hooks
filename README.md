# Getting Started with Truffle and React

## Introduction

This project is an update to the [Truffle Box "React"](https://www.trufflesuite.com/boxes/react). This Truffle Box illustrates a bare-bones React frontend interfacing to a smart contract. The initial goal of thios project was to port its frontend to use React "hooks" instead of using classes, as since React v16 more and more React frontends use this new paradigm.

In the process, the following changes were also added:
* add a `try/catch` to protect the error when the user forgets in MetaMask to use the local `develop` network generated by Truffle
* add the information to use `node v12.18.4` instead of the latest `v14`, with which `truffle 15.1` is incompatible and can't deploy its `develop` network
* modify `App.css` for another theme of colors than the original all-white theme.

## Install the demo
We'll use the console. The following installation instructions are for Linux or MacOS, that are Unix-based. If you run Windows, it is strongly recommended to install [VirtualBox](https://www.virtualbox.org/wiki/Downloads) and, inside it, install an Ubuntu virtual machine. See instruction guide for both installations in this 4-minute long [YouTube clip:](https://youtu.be/8mns5yqMfZk). 

### General setup context

Starting from scratch, you need to install `nodeJS`, then use the node package manager `npm` to install `truffle`.
* To install nodeJS on Ubuntu 20LTS, follow [these YouTube instructions](https://www.youtube.com/watch?v=OMhMnj7SBRQ)
* To install nodeJS on MacOS, follow [these instructions](https://dyclassroom.com/howto-mac/how-to-install-nodejs-and-npm-on-mac-using-homebrew)

Once `npm` is installed, use it to install `truffle`
```shell
    npm install -g truffle
```
Then you need to install a browser that is compatible with Metamask, like Chrome or Firefox. Chrome has better debugging tools.
* If you use MacOS, Chrome is available from [here](https://support.google.com/chrome/answer/95346?)
* If you use Ubuntu, download and install as below
``` bash
    $ wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    $ sudo apt install ./google-chrome-stable_current_amd64.deb
```
Finally, install Metamask extension for your browser and, later below, connect to the `truffle develop` local blockchain network and import the first account of the 10 that are generated.
  * [video guide to install Metamask](https://youtu.be/WAStJtjYI_c) 

### Specific Setup

* Clone this repository
``` shell
$ git clone https://github.com/kvutien/truffle-react-hooks.git 
    Cloning into 'truffle-react-hooks'...
    remote: Enumerating objects: 35, done.
    remote: Counting objects: 100% (35/35), done.
    remote: Compressing objects: 100% (31/31), done.
    remote: Total 35 (delta 4), reused 35 (delta 4), pack-reused 0
    Receiving objects: 100% (35/35), 770.87 KiB | 4.21 MiB/s, done.
    Resolving deltas: 100% (4/4), done.
$ cd truffle-react-hooks/client
```
* install the dependencies
``` shell
$ npm install
    ...
    found 566 vulnerabilities (1 low, 565 high)
    run `npm audit fix` to fix them, or `npm audit` for details
$
```
## Run the demo

* disregard the warnings. Compile and deploy the smart contract on the `truffle develop` local network.
``` shell
$ truffle develop
    ...
    Truffle Develop started at http://127.0.0.1:9545/

    Accounts:
    (0) 0x4d79c0d414e7e70b6323904d3a9085b86d8f82ff
    (1) 0xaebfe6f06361842eacd140646374e8d0110b0cc1
    (2) 0x49b56ee1f07a6fc72d808ed905f16a4c94869bbc
    (3) 0x71f165ead2cfca9221b53a6f5daae21682bd1055
    (4) 0x9b7a12cc33f8700f04f012836a3b6ba9583c2416
    (5) 0xcd81fd73490bba8b7030d9489e4475bcfe24e638
    (6) 0xbaf0bb7bc5cb3f542c7c46b7df9c26d894ce93e7
    (7) 0x2897aa7685e510a83a247927d780183a0dc2ad92
    (8) 0xa207ab0d24a16c604dc456f0e3974988c56c87d2
    (9) 0x129d24f41c27689ce13c2af546fc842f6ba30c81

    Private Keys:
    (0) 33f9646f72ff23f963d69889d45039602da387600fa7da4b41056890dd623f53
    (1) 54cf9b9e9caf2d328fab05a545d33403a992bea38ce1d2fd7277ce0b587ed7d3
    (2) 60ab4a3965b10a47a5880fafb1da7cd98153b297a8f69bc92bcdffb38272976e
    (3) b44ea1b784c84107237679782eabedce0565d028a075ec76552f8d04e080d79d
    (4) 34f2579734e55eade04420976e143fa2c814dfc8fcd4fc42263f19e95f4200cc
    (5) 1e139532c9e0eb2b441417f2f12501f52e55be6f127a6599e298e69138af009a
    (6) 31d4b5c4b095af854699aaa4eff1e3162d5a144e20cbf8d8cb2421955df29f8c
    (7) 8549d3ecaf12b8758216eeb5a662b7fe836a0478bc8542bb750376f1e3ce1cd8
    (8) 7564523a8e446c1081321cb0df81a7922a9ead7e1591d67b93da5f323de74a4e
    (9) 5bbdebd3941c7fc1584c290cb3f49d7995c1ff5910a5e3327e9f253f5560bc14

    Mnemonic: position wonder opera miss skirt stadium reject concert marble road cotton polar
    ⚠️  Important ⚠️  : This mnemonic was created for you by Truffle. It is not secure.
    Ensure you do not use it on production blockchains, or else you risk losing funds.

truffle(develop)> migrate
    Compiling your contracts...
    ===========================
    > Everything is up to date, there is nothing to compile.

    Starting migrations...
    ======================
    > Network name:    'develop'
    > Network id:      5777
    > Block gas limit: 6721975 (0x6691b7)

    1_initial_migration.js
    ======================
    Deploying 'Migrations'
    ----------------------
    > transaction hash:    0xc23fff0daf23c6ad8d94dc5905f8c42ed194c13f410725ba223956dac03797d1
    > Blocks: 0            Seconds: 0
    > contract address:    0x597328E0Ca20b7A7FEfc399e5E36Ab4Da4A5E43A
    > block number:        1
    > block timestamp:     1621626321
    > account:             0x4d79c0d414E7E70B6323904d3A9085B86d8f82Ff
    > balance:             99.99616114
    > gas used:            191943 (0x2edc7)
    > gas price:           20 gwei
    > value sent:          0 ETH
    > total cost:          0.00383886 ETH

    > Saving migration to chain.
    > Saving artifacts
    -------------------------------------
    > Total cost:          0.00383886 ETH

    2_deploy_contracts.js
    =====================
    Deploying 'SimpleStorage'
    -------------------------
    > transaction hash:    0xdeb51bc391752c01b61d5e925b288c69a2e426694a95444fcfdb9d6ad302ba19
    > Blocks: 0            Seconds: 0
    > contract address:    0x58919E4c76330DB629FC1D79bee533Fc6Aa1c4c0
    > block number:        3
    > block timestamp:     1621626322
    > account:             0x4d79c0d414E7E70B6323904d3A9085B86d8f82Ff
    > balance:             99.9933906
    > gas used:            96189 (0x177bd)
    > gas price:           20 gwei
    > value sent:          0 ETH
    > total cost:          0.00192378 ETH

    > Saving migration to chain.
    > Saving artifacts
    -------------------------------------
    > Total cost:          0.00192378 ETH

    Summary
    =======
    > Total deployments:   2
    > Final cost:          0.00576264 ETH
```

* make sure that your browser has a Metamask extension, that Metamask is using the truffle local develop network. Else the transaction will be refused and you have to refresh the screen to reload the dApp.
* run the demo by typing
``` shell
$ npm start
```
* your browser will open a new tab and display

![screenshot](./screenshot.png)

* once you confirm, the last line will show "The stored value is: 5". Your frontend is discussing with the smart contract.
* edit `App.js` to change the value in the line as recommended. Save. 
* observe that the web page is refreshed, that MetaMask asks you to confirm a transaction, and that after you confirm the new value is displayed.

## Most frequent errors
### `truffle develop` does nothing
When `truffle develop` doesn't display the 10 accounts generated as shown above, this is an incompatibility betwseen `truffle 5.1` and the version of `nodeJS`. Use [nvm](https://tecadmin.net/how-to-install-nvm-on-ubuntu-20-04/) (node version manager) to downgrade to `node 12.18.4`
``` shell
$ nvm use 12.18.4
```
### After MetaMask confirms, the last line still shows 'The stored value: not set yet'
You probably redeployed again the `truffle develop` network, making the new accounts mistmatch the accounts imported previously in MetaMask. Click on the "account" icon of MetaMask (top right) and chose "Settings", "Advanced", "Reset account". Reload the web page.

## Run Automated Tests on the demo
The demo contains an automated test in JavaScript and another automated test in Solidity
* the test in javaScript tests a smart contract that is already deployed. To execute this, you need to have the `truffle develop` network running and the smart contract migrated
* the test in Solidity tests a smart contract within the Solidity context. This is useful to test protocols that have to frontend. The automated test has the code to deploy the smart contract and interacts directly with it.

To run the tests inside `truffle develop`, simply type `test`

To run the tests from the command line, run the `truffle develop` network in another console and type `truffle test`

## Learn More

You can learn more in the [Create React App documentation](https://facebook.github.io/create-react-app/docs/getting-started).

To learn React, check out the [React documentation](https://reactjs.org/).

### Code Splitting

This section has moved here: [https://facebook.github.io/create-react-app/docs/code-splitting](https://facebook.github.io/create-react-app/docs/code-splitting)

### Analyzing the Bundle Size

This section has moved here: [https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size](https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size)

### Making a Progressive Web App

This section has moved here: [https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app](https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app)

### Advanced Configuration

This section has moved here: [https://facebook.github.io/create-react-app/docs/advanced-configuration](https://facebook.github.io/create-react-app/docs/advanced-configuration)

### Deployment

This section has moved here: [https://facebook.github.io/create-react-app/docs/deployment](https://facebook.github.io/create-react-app/docs/deployment)

### `yarn build` fails to minify

This section has moved here: [https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify](https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify)
